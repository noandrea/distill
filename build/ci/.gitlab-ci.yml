image: welance/build-golang:1.10

stages:
  - test
  - build
  - publish

before_script:
  - cd $GOPATH/src
  - mkdir -p gitlab.com/$CI_PROJECT_NAMESPACE
  - cd gitlab.com/$CI_PROJECT_NAMESPACE
  - ln -s $CI_PROJECT_DIR
  - cd $CI_PROJECT_NAME
  - echo -e "machine gitlab.com\nlogin gitlab-ci-token\npassword ${CI_JOB_TOKEN}" > ~/.netrc
  - dep ensure -vendor-only

lint_code:
  stage: test
  script:
    - make lint

unit_tests:
  stage: test
  script:
    - make test

build:
  stage: build
  script:
    - make docker TAG=$CI_COMMIT_TAG
  only:
    - tags

docker-build:
  stage: publish
  script:
    - make docker-push TAG=$CI_COMMIT_TAG
  only:
    - tags